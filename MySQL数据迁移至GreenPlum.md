## MySQL数据迁移至GreenPlum

> greenplum作为OLAP分析型软件，自然避免不了从外部数据库加载大量的数据，然而传统的ETL数据传输方法（select=>insert）到GP需要经过GP的单点master，效率非常低。

### 介绍外部表用gpfdist快速导入数据：

普通外部表和可写外部表区别：

1、普通外部表只能select,可写外部表只能insert

2、可写外部表没有错误表

3、可写外部表可以指定分布键，如果不指定，默认随机分布；普通外部表只能随机分布

**gpfdist优势：**

1、直接由segment并发加载

2、直接加载数据文件，并可读写（和选择的外部表类型有关）

3、默认数据随机分配，每个节点负载均衡（和选择的外部表类型有关）

### 示例：
1、启动gpfdist

安装完GP后，自带gpfdist文件，直接指定目录、端口等就能启动服务。如果需要独立的文件服务器，则需要在文件服务器上单独下载gpfdist使用

```
gpadmin@gp1:~$ nohup  gpfdist -p 8081 -d /data/upload >/dev/null 2>&1 &
[1] 7214
gpadmin@gp1:~$ ps -ef | grep gpfdist
gpadmin   7214  7000  0 00:09 pts/8    00:00:00 gpfdist -p 8081 -d /data/upload
gpadmin   7220  7000  0 00:09 pts/8    00:00:00 grep --color=auto gpfdist
```

使用nohup &是起守护进程作用，指定端口8081，指定文件目录/data/upload

2、创建外部表：

```
CREATE  EXTERNAL TABLE "EXP_V_TBL_USER_ORDER" (ID int4, PACKAGE_ID int4, SHOOT_TIME_COST int4, ORDER_ID text, ORDER_PRICE numeric, ORDER_PA
Y_PRICE numeric, ORDER_STATE int4, PAY_STATE int4, ORDER_TIME timestamp, ACTIVITY_BUDGET_MIN int4, ACTIVITY_BUDGET_MAX int4, SHOOTING_JOIN_NUMBER flo
at8, CITY_CODE text, SHOOTING_ADDRESS text, SHOOTING_TIME_STATE int4, SHOOTING_TIME_START timestamp, SHOOTING_TIME_END timestamp, REQUIREMENT_DESCRIP
TION text, PHOTOGRAPHER_LEVEL_CODE text, PHOTOGRAPHER_NUMBER_CODE text, USER_ID int4, USER_NAME text, USER_COMPANY text, USER_PHONE text, USER_EMAIL 
text, WEIXIN_CONTENT text, UPDATE_TIME timestamp, SHOOTING_NAME text, PREPARE_PHOTOGRAPHER_PRICE numeric, ORDER_TYPE int4, NEGATIVE_REFINEMENT_NUMBER
 int4, WIFI_FLAG text, ACCOUNT_ID int4, ACTIVITY_DISCOUNT_CODE int4, ADD_SHOOT_TIME int4, COMPANY_PAY_PROFITS float8, OTHER_EXPENSES float8, OTHER_EX
PENSES_DESCRIPTION text, SHOOTING_SCENE_CODE text, SUIT_PERSON_CODE text, PHOTOGRAPHER_SELECT_TYPE text, ADD_PAYMENT_CODE text, BILLING_RULES_CODE te
xt, PAYMENT_TIME_END timestamp, USE_VPHOTOS_LOGO int4, USER_COMPANY_JC text, SUBACCOUNT_ID int4, RECOMMEND_ID int4, RECOMMEND_TYPE int4, AUTH_SELECTE
D_NUM int4, CAN_VIEW int4, USER_ID_PK int4, CAN_DOWNLOAD int4, CONTRACT_ID int4, CREATE_USER_ID int4, CUS_TAGLIB_TYPE_ID int4, CUSTOM_HEIGHT int4, CU
STOM_TYPE int4, CUSTOM_WIDTH int4, DEFAULT_DOWN_CODE text, digital_num text, DIGITAL_SCORE int4, DOUBLE_SIZE int4, DOUBLE_TYPE int4, NETWORK_SIZE int
4, NETWORK_TYPE int4, OFFER_FOOD int4, OFFER_TRAFFIC int4, ORDER_END_TIME timestamp, ORDER_PAY_TIME timestamp, ORIGINAL_SIZE int4, ORIGINAL_TYPE int4
, PHOTOGRAPHER_NUM int4, POSITION int4, POSITION_X int4, POSITION_Y int4, READY_SHOOT_TIME timestamp, REQUIREMENT_ID int4, SALE_PERSON int4, SCORE_CO
MMENT text, SCORE_DATE timestamp, SCORE_STATE int4, SELECT_NUM int4, SERVICE_SCORE int4, SHOOT_SCORE int4, THUMBNAIL_SIZE int4, VIEW_PRICE float8, sa
lePerson text, FINAL_PROCESS int4, AUDIT_DIRECT int4, SELECT_POSTP_NUM int4, VPHOTOS_LOGO_POSITION int4, AUTO_HAND_SEQ int4, CUS_ID int4, CUS_SELECT 
int4, LIVE_VALIDATE int4, NEED_RAW int4, ORDER_LEVEL int4, PHOTO_SEQ int4, POSTP_NUM int4, SUCCESS_ID int4, TRANS_FIRST int4, TRANS_FIRST_NUM int4, T
RANS_MODEL int4, ORDER_TEMPLATE_ID int4, TOUR_ORDER_ID int4, CAUTION text, JPG_ORIGINAL int4, NEW_ORDER_TYPE int4, MOVE_ORDER_ID int4, ORDER_CATEGORY
 int4, CUS_COM_SET_FINAL int4, CUS_COM_SET_POSTP int4, CUS_COM_SET_SELECTED int4, DOUBLE_COM_SET_FINAL int4, DOUBLE_COM_SET_POSTP int4, DOUBLE_COM_SE
T_SELECTED int4, DURE_MODEL_NEGATIVE int4, DURE_MODEL_ORI int4, DURE_MODEL_PREVIEW int4, EXPIRE_PERIOD int4, EXPIRE_SET int4, NET_WORK_COM_SET_FINAL 
int4, NET_WORK_COM_SET_POSTP int4, NET_WORK_COM_SET_SELECTED int4, ORIGINAL_COM_SET_FINAL int4, ORIGINAL_COM_SET_POSTP int4, ORIGINAL_COM_SET_SELECTE
D int4, THUMBNAIL_COM_SET_FINAL int4, THUMBNAIL_COM_SET_POSTP int4, THUMBNAIL_COM_SET_SELECTED int4, TRANS_FIRST_RAW int4, TRANS_FIRST_RAW_NUM int4, 
VBOX_SET_SELECTED int4, BASE_PRICE float8, USE_WATER_MARK int4, ORDER_PHOTO_BELONG int4, vboxCreate int4, VBOX_CREATE int4, SOURCE_TYPE int4, BACK_MO
NEY float8, DIGITAL_CONSUMPTION_NUM int4, PHOTOGRAPHER_CONSUMPTION_NUM int4, SELF_DIGITAL_NUM int4, SELF_PHOTOGRAPHER_NUM int4, REFUND_MONEY float8, 
CONFIRM_STATE int4, SETTLE_WAY int4, VER int4, BAD_DEBT_SOURCE_ORDER_ID int4, groupBuyId int4, CRM_CONTRACT_REMAKE text, CRM_GET_ALBUM_TYPE int4, CRM
_IMPORTANT_ORDER_MARK int4, CRM_IS_AUTH_VPHOTO int4, CRM_ORDER_CODE text, CRM_ORDER_ID text, CRM_LINKMAN_NAME text, CRM_LINKMAN_PHONE text, CRM_IS_AL
BUM_BANNER int4, CRM_IS_ALBUM_COVER int4, CRM_IS_PIC_WATERMARK int4, CRM_REMARK text) LOCATION ('gpfdist://10.3.141.12:8081/V_TBL_USER_ORDER.csv') FO
RMAT 'csv' (DELIMITER ';');
```

3、创建内部表：

```
CREATE TABLE "V_TBL_USER_ORDER" (ID int4, PACKAGE_ID int4, SHOOT_TIME_COST int4, ORDER_ID text, ORDER_PRICE numeric, ORDER_PAY_PRICE numeric, ORDER_STATE int4, PAY_STATE int4, ORDER_TIME timestamp, ACTIVITY_BUDGET_MIN int4, ACTIVITY_BUDGET_MAX int4, SHOOTING_JOIN_NUMBER float8, CITY_CODE text, SHOOTING_ADDRESS text, SHOOTING_TIME_STATE int4, SHOOTING_TIME_START timestamp, SHOOTING_TIME_END timestamp, REQUIREMENT_DESCRIPTION text, PHOTOGRAPHER_LEVEL_CODE text, PHOTOGRAPHER_NUMBER_CODE text, USER_ID int4, USER_NAME text, USER_COMPANY text, USER_PHONE text, USER_EMAIL text, WEIXIN_CONTENT text, UPDATE_TIME timestamp, SHOOTING_NAME text, PREPARE_PHOTOGRAPHER_PRICE numeric, ORDER_TYPE int4, NEGATIVE_REFINEMENT_NUMBER int4, WIFI_FLAG text, ACCOUNT_ID int4, ACTIVITY_DISCOUNT_CODE int4, ADD_SHOOT_TIME int4, COMPANY_PAY_PROFITS float8, OTHER_EXPENSES float8, OTHER_EXPENSES_DESCRIPTION text, SHOOTING_SCENE_CODE text, SUIT_PERSON_CODE text, PHOTOGRAPHER_SELECT_TYPE text, ADD_PAYMENT_CODE text, BILLING_RULES_CODE text, PAYMENT_TIME_END timestamp, USE_VPHOTOS_LOGO int4, USER_COMPANY_JC text, SUBACCOUNT_ID int4, RECOMMEND_ID int4, RECOMMEND_TYPE int4, AUTH_SELECTED_NUM int4, CAN_VIEW int4, USER_ID_PK int4, CAN_DOWNLOAD int4, CONTRACT_ID int4, CREATE_USER_ID int4, CUS_TAGLIB_TYPE_ID int4, CUSTOM_HEIGHT int4, CUSTOM_TYPE int4, CUSTOM_WIDTH int4, DEFAULT_DOWN_CODE text, digital_num text, DIGITAL_SCORE int4, DOUBLE_SIZE int4, DOUBLE_TYPE int4, NETWORK_SIZE int4, NETWORK_TYPE int4, OFFER_FOOD int4, OFFER_TRAFFIC int4, ORDER_END_TIME timestamp, ORDER_PAY_TIME timestamp, ORIGINAL_SIZE int4, ORIGINAL_TYPE int4, PHOTOGRAPHER_NUM int4, POSITION int4, POSITION_X int4, POSITION_Y int4, READY_SHOOT_TIME timestamp, REQUIREMENT_ID int4, SALE_PERSON int4, SCORE_COMMENT text, SCORE_DATE timestamp, SCORE_STATE int4, SELECT_NUM int4, SERVICE_SCORE int4, SHOOT_SCORE int4, THUMBNAIL_SIZE int4, VIEW_PRICE float8, salePerson text, FINAL_PROCESS int4, AUDIT_DIRECT int4, SELECT_POSTP_NUM int4, VPHOTOS_LOGO_POSITION int4, AUTO_HAND_SEQ int4, CUS_ID int4, CUS_SELECT int4, LIVE_VALIDATE int4, NEED_RAW int4, ORDER_LEVEL int4, PHOTO_SEQ int4, POSTP_NUM int4, SUCCESS_ID int4, TRANS_FIRST int4, TRANS_FIRST_NUM int4, TRANS_MODEL int4, ORDER_TEMPLATE_ID int4, TOUR_ORDER_ID int4, CAUTION text, JPG_ORIGINAL int4, NEW_ORDER_TYPE int4, MOVE_ORDER_ID int4, ORDER_CATEGORY int4, CUS_COM_SET_FINAL int4, CUS_COM_SET_POSTP int4, CUS_COM_SET_SELECTED int4, DOUBLE_COM_SET_FINAL int4, DOUBLE_COM_SET_POSTP int4, DOUBLE_COM_SET_SELECTED int4, DURE_MODEL_NEGATIVE int4, DURE_MODEL_ORI int4, DURE_MODEL_PREVIEW int4, EXPIRE_PERIOD int4, EXPIRE_SET int4, NET_WORK_COM_SET_FINAL int4, NET_WORK_COM_SET_POSTP int4, NET_WORK_COM_SET_SELECTED int4, ORIGINAL_COM_SET_FINAL int4, ORIGINAL_COM_SET_POSTP int4, ORIGINAL_COM_SET_SELECTED int4, THUMBNAIL_COM_SET_FINAL int4, THUMBNAIL_COM_SET_POSTP int4, THUMBNAIL_COM_SET_SELECTED int4, TRANS_FIRST_RAW int4, TRANS_FIRST_RAW_NUM int4, VBOX_SET_SELECTED int4, BASE_PRICE float8, USE_WATER_MARK int4, ORDER_PHOTO_BELONG int4, vboxCreate int4, VBOX_CREATE int4, SOURCE_TYPE int4, BACK_MONEY float8, DIGITAL_CONSUMPTION_NUM int4, PHOTOGRAPHER_CONSUMPTION_NUM int4, SELF_DIGITAL_NUM int4, SELF_PHOTOGRAPHER_NUM int4, REFUND_MONEY float8, CONFIRM_STATE int4, SETTLE_WAY int4, VER int4, BAD_DEBT_SOURCE_ORDER_ID int4, groupBuyId int4, CRM_CONTRACT_REMAKE text, CRM_GET_ALBUM_TYPE int4, CRM_IMPORTANT_ORDER_MARK int4, CRM_IS_AUTH_VPHOTO int4, CRM_ORDER_CODE text, CRM_ORDER_ID text, CRM_LINKMAN_NAME text, CRM_LINKMAN_PHONE text, CRM_IS_ALBUM_BANNER int4, CRM_IS_ALBUM_COVER int4, CRM_IS_PIC_WATERMARK int4, CRM_REMARK text) with (APPENDONLY=true, ORIENTATION=column, COMPRESSTYPE=zlib, COMPRESSLEVEL=1, BLOCKSIZE=1048576, OIDS=false) DISTRIBUTED BY (ID);
```

4、全表迁移：

```
INSERT  INTO public."V_TBL_USER_ORDER" SELECT  * FROM public."EXP_V_TBL_USER_ORDER";
```


**FAQ**
Q1:

```
ERROR:  missing data for column "package_id"  (seg2 slice1 10.3.141.13:40000 pid=948)
DETAIL:  External table EXP_V_TBL_USER_ORDER, line 291 of gpfdist://10.3.141.12:8081/V_TBL_USER_ORDER.csv: ""489","3","4","OD20160311112517712130","230","230","70","80","11/3/2016 11:25:17",,,"1","ALL","新..."
```
A2:


参考：

https://sq.163yun.com/blog/article/174998395898531840

https://blog.csdn.net/u010070255/article/details/78120648